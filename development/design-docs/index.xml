<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Cloud Provider Azure – Design Docs and KEPs</title><link>https://cloud-provider-azure.sigs.k8s.io/development/design-docs/</link><description>Recent content in Design Docs and KEPs on Cloud Provider Azure</description><generator>Hugo -- gohugo.io</generator><atom:link href="https://cloud-provider-azure.sigs.k8s.io/development/design-docs/index.xml" rel="self" type="application/rss+xml"/><item><title>Development: Azure Private Link Service Integration</title><link>https://cloud-provider-azure.sigs.k8s.io/development/design-docs/pls-integration/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://cloud-provider-azure.sigs.k8s.io/development/design-docs/pls-integration/</guid><description>
&lt;p>Azure Private Link Service (PLS) is an infrastructure component that allows users to privately connect via a Private Endpoint (PE) in a VNET in Azure and a Frontend IP Configuration associated with an Azure Load Balancer (ALB). With Private Link, users as service providers can securely provide their services to consumers who can connect from within Azure or on-premises without data exfiltration risks.&lt;/p>
&lt;p>Before Private Link Service integration, users who wanted private connectivity from on-premises or other VNETs to their services in the Azure Kubernetes cluster were required to create a Private Link Service (PLS) to reference the Azure Internal LoadBalancer. The user would then create a Private Endpoint (PE) to connect to the PLS to enable private connectivity. With this feature, a managed PLS to the LB would be created automatically, and the user would only be required to create PE connections to it for private connectivity.&lt;/p>
&lt;p>Currently, managed private link service only works with Azure Internal Standard Load Balancer. Users who want to use private link service for their Kubernetes services must set annotation &lt;code>service.beta.kubernetes.io/azure-load-balancer-internal&lt;/code> to be &lt;code>true&lt;/code> (&lt;a href="../../../topics/loadbalancer">Doc&lt;/a>).&lt;/p>
&lt;h2 id="privatelinkservice-annotations">PrivateLinkService annotations&lt;/h2>
&lt;p>Below is a list of annotations supported for Kubernetes services with Azure PLS created:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Annotation&lt;/th>
&lt;th>Value&lt;/th>
&lt;th>Description&lt;/th>
&lt;th>Required&lt;/th>
&lt;th>Default&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>service.beta.kubernetes.io/azure-pls-create&lt;/code>&lt;/td>
&lt;td>&lt;code>&amp;quot;true&amp;quot;&lt;/code>&lt;/td>
&lt;td>Boolean indicating whether a PLS needs to be created.&lt;/td>
&lt;td>Required&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>service.beta.kubernetes.io/azure-pls-name&lt;/code>&lt;/td>
&lt;td>&lt;code>&amp;lt;PLS name&amp;gt;&lt;/code>&lt;/td>
&lt;td>String specifying the name of the PLS resource to be created.&lt;/td>
&lt;td>Optional&lt;/td>
&lt;td>&lt;code>&amp;quot;pls-&amp;lt;LB frontend config name&amp;gt;&amp;quot;&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>service.beta.kubernetes.io/azure-pls-ip-configuration-subnet&lt;/code>&lt;/td>
&lt;td>&lt;code>&amp;lt;Subnet name&amp;gt;&lt;/code>&lt;/td>
&lt;td>String indicating the subnet to which the PLS will be deployed. This subnet must exist in the same VNET as the backend pool. PLS NAT IPs are allocated within this subnet.&lt;/td>
&lt;td>Optional&lt;/td>
&lt;td>If &lt;code>service.beta.kubernetes.io/azure-load-balancer-internal-subnet&lt;/code>, this LB subnet is used. Otherwise, the default subnet from config file is used.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>service.beta.kubernetes.io/azure-pls-ip-configuration-ip-address-count&lt;/code>&lt;/td>
&lt;td>&lt;code>[1-8]&lt;/code>&lt;/td>
&lt;td>Total number of private NAT IPs to allocate.&lt;/td>
&lt;td>Optional&lt;/td>
&lt;td>1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>service.beta.kubernetes.io/azure-pls-ip-configuration-ip-address&lt;/code>&lt;/td>
&lt;td>&lt;code>&amp;quot;10.0.0.7 ... 10.0.0.10&amp;quot;&lt;/code>&lt;/td>
&lt;td>A space separated list of static &lt;strong>IPv4&lt;/strong> IPs to be allocated. (IPv6 is not supported right now.) Total number of IPs should not be greater than the ip count specifed in &lt;code>service.beta.kubernetes.io/azure-pls-ip-configuration-ip-address-count&lt;/code>. If there are fewer IPs specified, the rest are dynamically allocated. The first IP in the list is set as &lt;code>Primary&lt;/code>.&lt;/td>
&lt;td>Optional&lt;/td>
&lt;td>All IPs are dynamically allocated.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>service.beta.kubernetes.io/azure-pls-fqdns&lt;/code>&lt;/td>
&lt;td>&lt;code>&amp;quot;fqdn1 fqdn2&amp;quot;&lt;/code>&lt;/td>
&lt;td>A space separated list of fqdns associated with the PLS.&lt;/td>
&lt;td>Optional&lt;/td>
&lt;td>&lt;code>[]&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>service.beta.kubernetes.io/azure-pls-proxy-protocol&lt;/code>&lt;/td>
&lt;td>&lt;code>&amp;quot;true&amp;quot;&lt;/code> or &lt;code>&amp;quot;false&amp;quot;&lt;/code>&lt;/td>
&lt;td>Boolean indicating whether the TCP PROXY protocol should be enabled on the PLS to pass through connection information, including the link ID and source IP address. Note that the backend service MUST support the PROXY protocol or the connections will fail.&lt;/td>
&lt;td>Optional&lt;/td>
&lt;td>&lt;code>false&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>service.beta.kubernetes.io/azure-pls-visibility&lt;/code>&lt;/td>
&lt;td>&lt;code>&amp;quot;sub1 sub2 sub3 … subN&amp;quot;&lt;/code> or &lt;code>&amp;quot;*&amp;quot;&lt;/code>&lt;/td>
&lt;td>A space separated list of Azure subscription ids for which the private link service is visible. Use &lt;code>&amp;quot;*&amp;quot;&lt;/code> to expose the PLS to all subs (Least restrictive).&lt;/td>
&lt;td>Optional&lt;/td>
&lt;td>Empty list &lt;code>[]&lt;/code> indicating role-based access control only: This private link service will only be available to individuals with role-based access control permissions within your directory. (Most restrictive)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>service.beta.kubernetes.io/azure-pls-auto-approval&lt;/code>&lt;/td>
&lt;td>&lt;code>&amp;quot;sub1 sub2 sub3 … subN&amp;quot;&lt;/code>&lt;/td>
&lt;td>A space separated list of Azure subscription ids. This allows PE connection requests from the subscriptions listed to the PLS to be automatically approved. This only works when visibility is set to &amp;ldquo;*&amp;rdquo;.&lt;/td>
&lt;td>Optional&lt;/td>
&lt;td>&lt;code>[]&lt;/code>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>For more details about each configuration, please refer to &lt;a href="https://docs.microsoft.com/en-us/cli/azure/network/private-link-service?view=azure-cli-latest#az-network-private-link-service-create">Azure Private Link Service Documentation&lt;/a>.&lt;/p>
&lt;h2 id="design-details">Design Details&lt;/h2>
&lt;h3 id="creating-managed-privatelinkservice">Creating managed PrivateLinkService&lt;/h3>
&lt;p>When a &lt;code>LoadBalancer&lt;/code> typed service is created without the &lt;code>loadBalancerIP&lt;/code> field specified, an LB frontend IP configuration is created with a dynamically generated IP. If the service has &lt;code>loadBalancerIP&lt;/code> in its spec, an existing LB frontend IP configuration may be reused if one exists; otherwise a static configuration is created with the specified IP. When a service is created with annotation &lt;code>service.beta.kubernetes.io/azure-pls-create&lt;/code> set to &lt;code>true&lt;/code> or updated later with the annotation added, a PLS resource attached to the LB frontend is created in the default resource group or the resource group user set in config file with key &lt;code>PrivateLinkServiceResourceGroup&lt;/code>.&lt;/p>
&lt;p>The Kubernetes service creating the PLS is assigned as the owner of the resource. Azure cloud provider tags the PLS with cluster name and service name &lt;code>kubernetes-owner-service: &amp;lt;namespace&amp;gt;/&amp;lt;service name&amp;gt;&lt;/code>. Only the owner service can later update the properties of the PLS resource.&lt;/p>
&lt;p>If there&amp;rsquo;s a managed PLS already created for the LB frontend, the same PLS is reused automatically since each LB frontend can be referenced by only one PLS. If the LB frontend is attached to a user defined PLS, service creation should fail with proper error logged.&lt;/p>
&lt;p>For now, Azure cloud provider does not manage any &lt;a href="https://docs.microsoft.com/en-us/azure/private-link/private-endpoint-overview">Private Link Endpoint&lt;/a> resources. Once a PLS is created, users can create their own PEs to connect to the PLS.&lt;/p>
&lt;h3 id="deleting-managed-privatelinkservice">Deleting managed PrivateLinkService&lt;/h3>
&lt;p>Once a PLS is created, it shares the lifetime of the LB frontend IP configuration and is deleted only when its corresponding LB frontend gets deleted. As a result, a PLS may still exist even when its owner service is deleted. This is out of the consideration that multiple Kubernetes services can share the same LB frontend IP configuration and thus share the PLS automatically. More details are discussed in &lt;a href="#sharing-managed-privatelinkservice">next section&lt;/a>.&lt;/p>
&lt;p>If there are active PE connections to the PLS, all connections are removed and the PEs become obsolete. Users are responsible for cleaning up the PE resources.&lt;/p>
&lt;h3 id="sharing-managed-privatelinkservice">Sharing managed PrivateLinkService&lt;/h3>
&lt;p>Multiple Kubernetes services can share the same LB frontend by specifying the same &lt;code>loadBalancerIP&lt;/code> (for more details, please refer to &lt;a href="../../../topics/shared-ip">Multiple Services Sharing One IP Address&lt;/a>). Once a PLS is attached to the LB frontend, these services automatically share the PLS. Users can access these services via the same PE but different ports.&lt;/p>
&lt;p>Azure cloud provider tags the service creating the PLS as the owner (&lt;code>kubernetes-owner-service: &amp;lt;namespace&amp;gt;/&amp;lt;service name&amp;gt;&lt;/code>) and only allows that service to update the configurations of the PLS. If the owner service is deleted or if user wants some other service to take control, user can modify the tag value to a new service in &lt;code>&amp;lt;namespace&amp;gt;/&amp;lt;service name&amp;gt;&lt;/code> pattern.&lt;/p>
&lt;p>PLS is only automatically deleted when the LB frontend IP configuration is deleted. One can delete a service while preserving the PLS by creating a temporary service referring to the same LB frontend.&lt;/p>
&lt;h3 id="managed-privatelinkservice-creation-example">Managed PrivateLinkService Creation example&lt;/h3>
&lt;p>Below we provide an example for creating a Kubernetes service object with Azure ILB and PLS created:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="color:#204a87;font-weight:bold">apiVersion&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">v1&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">kind&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">Service&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">metadata&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">name&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">myService&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">annotations&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">service.beta.kubernetes.io/azure-load-balancer-internal&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#4e9a06">&amp;#34;true&amp;#34;&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#8f5902;font-style:italic"># Right now PLS must be used with internal LB&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">service.beta.kubernetes.io/azure-pls-create&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#4e9a06">&amp;#34;true&amp;#34;&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">service.beta.kubernetes.io/azure-pls-name&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">myServicePLS&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">service.beta.kubernetes.io/azure-pls-ip-configuration-subnet&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">pls-subnet&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">service.beta.kubernetes.io/azure-pls-ip-configuration-ip-address-count&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#4e9a06">&amp;#34;1&amp;#34;&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">service.beta.kubernetes.io/azure-pls-ip-configuration-ip-address&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">10.240.0.9&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#8f5902;font-style:italic"># Must be available in pls-subnet&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">service.beta.kubernetes.io/azure-pls-fqdns&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#4e9a06">&amp;#34;fqdn1 fqdn2&amp;#34;&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">service.beta.kubernetes.io/azure-pls-proxy-protocol&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#4e9a06">&amp;#34;false&amp;#34;&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">service.beta.kubernetes.io/azure-pls-visibility&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#4e9a06">&amp;#34;*&amp;#34;&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">service.beta.kubernetes.io/azure-pls-auto-approval&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#4e9a06">&amp;#34;subId1&amp;#34;&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">spec&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">type&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">LoadBalancer&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">selector&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">app&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">myApp&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">ports&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>- &lt;span style="color:#204a87;font-weight:bold">name&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">myAppPort&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">protocol&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">TCP&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">port&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">80&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">targetPort&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">80&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item></channel></rss>